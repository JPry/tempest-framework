#!/usr/bin/env bash

PACKAGE_NAME=$1
SUBSPLIT_DIR="${PACKAGE_NAME}_subsplit"
ORG_NAME="tempestphp"
REPOSITORY_NAME="tempest-${PACKAGE_NAME}"

# Check if the split repository exists, if not create it
if ! gh repo view "${ORG_NAME}/${REPOSITORY_NAME}" &>/dev/null; then
  gh repo create "${ORG_NAME}/${REPOSITORY_NAME}" \
    --public \
    --description "[READ ONLY] Sub split of the Tempest ${PACKAGE_NAME} component." \
    --disable-issues \
    --disable-wiki
fi

# Clone our Tempest repository and jump into it.
git clone https://github.com/tempestphp/tempest-framework "$SUBSPLIT_DIR"
cd "$SUBSPLIT_DIR"

# Get the current default branch of the Tempest repo.
DEFAULT_BRANCH=$(git branch --show-current)

# Filter the history down to only the one package.
git filter-repo --subdirectory-filter "packages/${PACKAGE_NAME}"

# Setup our remote repository we are splitting to.
git remote add origin "https://x-access-token:${SUBSPLIT_TOKEN}@github.com/${ORG_NAME}/${REPOSITORY_NAME}.git"
git branch -m "$DEFAULT_BRANCH"

# Push all branches + history to the repo.
git push --force --all origin

# Push all releases / tags to the repo.
git push --force --tags origin

# Cleanup
cd ../
rm -rf "${SUBSPLIT_DIR}"
